<!DOCTYPE html>  <html> <head>   <title>fbscrap.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               fbscrap.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>Some module requires</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">fs = </span><span class="nx">require</span> <span class="s">&quot;fs&quot;</span>
<span class="nv">async = </span><span class="nx">require</span> <span class="s">&quot;async&quot;</span>
<span class="nv">request = </span><span class="nx">require</span> <span class="s">&quot;request&quot;</span>
<span class="nv">_ = </span><span class="nx">require</span> <span class="s">&quot;underscore&quot;</span>
<span class="nv">moment = </span><span class="nx">require</span> <span class="s">&quot;moment&quot;</span>
<span class="nv">ProgressBar = </span><span class="nx">require</span> <span class="s">&quot;progress&quot;</span>
<span class="nv">program = </span><span class="nx">require</span> <span class="s">&quot;commander&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h1>Scrapper</h1>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Let's begin making our scrapper! </p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Scrapper</span>
  <span class="nv">constructor: </span><span class="nf">-&gt;</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;\n\n===Facebook Page Image Scrapper===&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Parse command line options</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">program</span><span class="p">.</span><span class="nx">version</span><span class="p">(</span><span class="s">&quot;0.0.1&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">option</span><span class="p">(</span><span class="s">&quot;-p, --page &lt;page&gt;&quot;</span><span class="p">,</span> <span class="s">&quot;Facebook Page ID that you want to scrap. For example, https://www.facebook.com/starbucks page ID will be starbucks&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">option</span><span class="p">(</span><span class="s">&quot;-t, --token &lt;token&gt;&quot;</span><span class="p">,</span> <span class="s">&quot;Your access token. Generate an access token from https://developers.facebook.com/tools/explorer&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">option</span><span class="p">(</span><span class="s">&quot;-l, --limit &lt;limit&gt;&quot;</span><span class="p">,</span> <span class="s">&quot;Maximum number of images that you want to scrap, defaults to 10&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">option</span><span class="p">(</span><span class="s">&quot;-o, --output &lt;output&gt;&quot;</span><span class="p">,</span> <span class="s">&quot;Where to store the images. Defaults to ./images&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Check if user supplied page ID</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="o">not</span> <span class="nx">program</span><span class="p">.</span><span class="nx">page</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">error</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">        \nPage ID not found. Please supply a Facebook Page Id, e.g. </span>
<span class="s">        </span>
<span class="s">        scrapper -p kpopmusiclove -t &lt;accesstoken&gt;</span>

<span class="s">      &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Check if user supplied access token</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="o">not</span> <span class="nx">program</span><span class="p">.</span><span class="nx">token</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">error</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">        \nAccess token not found. Please supply a valid access token. You can get one from</span>
<span class="s">        https://developers.facebook.com/tools/explorer</span>

<span class="s">        Then you can run: </span>

<span class="s">        scrapper -p &lt;facebook page id&gt; -t &lt;access token&gt;</span>

<span class="s">      &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <h1>Set program variables</h1>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>limit: maximum amount of images to scrap</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@limit = </span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">program</span><span class="p">.</span><span class="nx">limit</span><span class="p">)</span> <span class="o">||</span> <span class="mi">10</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>outputDir
Where to store the images in </p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@outputDir = </span><span class="nx">program</span><span class="p">.</span><span class="nx">output</span> <span class="o">||</span> <span class="s">&quot;./images&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>fbPageId:
Page ID of the Facebook page we are scrapping. For example, </p>

<p>Url: https://www.facebook.com/kpopmusiclove
PageId: kpopmusiclove</p>

<p>Url: https://www.facebook.com/Starbucks?fref=ts
PageId: Starbucks</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@fbPageId = </span><span class="nx">program</span><span class="p">.</span><span class="nx">page</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>accessToken:
We need a valid access token for scrapping pages. Just go to 
https://developers.facebook.com/tools/explorer
to get a temporary access token that you can use. For testing purposes
this access token will only last for 2 hours. </p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@accessToken = </span><span class="nx">program</span><span class="p">.</span><span class="nx">token</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Some internal variables</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@pageDir = </span><span class="s">&quot;&quot;</span> <span class="c1"># Page directory, where to store images later</span>
    <span class="vi">@nextPageLink = </span><span class="s">&quot;&quot;</span> <span class="c1"># Link to next page to get list of page links</span>
    <span class="vi">@images = </span><span class="p">[]</span> <span class="c1"># Array of image links to download later</span>
    <span class="vi">@bar = </span><span class="p">{}</span> <span class="c1"># Progress bar</span>

    <span class="nx">@init</span><span class="p">()</span>

  <span class="nv">init: </span><span class="nf">-&gt;</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;Facebook Page ID: </span><span class="si">#{</span><span class="nx">@fbPageId</span><span class="si">}</span><span class="s">\n&quot;</span>

    <span class="nx">async</span><span class="p">.</span><span class="nx">series</span>
      <span class="nv">getPageInfo: </span><span class="nx">@getPageInfo</span>
      <span class="nv">getImages: </span><span class="nx">@getImages</span>
      <span class="nv">createFolders: </span><span class="nx">@createFolders</span>
      <span class="nv">downloadImages: </span><span class="nx">@downloadImages</span>
    <span class="p">,</span> <span class="nf">(err) =&gt;</span>
      <span class="k">if</span> <span class="nx">err</span> 
        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span> <span class="s">&quot;\n\n Error:&quot;</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span> <span class="nx">err</span>
      <span class="k">else</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;\n\n\nDone!\nYou can now check your images at </span><span class="si">#{</span><span class="nx">@pageDir</span><span class="si">}</span><span class="s">.\n\n&quot;</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;===Thank you and come again!===\n&quot;</span>
      
      <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">()</span>

  <span class="nv">getPageInfo: </span><span class="nf">(callback) =&gt;</span>
    <span class="nv">url = </span><span class="s">&quot;https://graph.facebook.com/</span><span class="si">#{</span><span class="nx">@fbPageId</span><span class="si">}</span><span class="s">?access_token=</span><span class="si">#{</span><span class="nx">@accessToken</span><span class="si">}</span><span class="s">&quot;</span>

    <span class="nx">request</span><span class="p">.</span><span class="nx">get</span> <span class="nx">url</span><span class="p">,</span> 
      <span class="nv">json: </span><span class="kc">true</span>
    <span class="p">,</span> <span class="nf">(err, body, response) =&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Handle errors</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">err</span> <span class="k">then</span> <span class="k">return</span> <span class="nx">callback</span> <span class="nx">err</span>
      <span class="k">if</span> <span class="nx">response</span><span class="p">.</span><span class="nx">error</span> <span class="k">then</span> <span class="k">return</span> <span class="nx">callback</span> <span class="nx">response</span><span class="p">.</span><span class="nx">error</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Create path to page directory based on page name
e.g. ./images/KPop Music Videos/</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">pageName = </span><span class="nx">response</span><span class="p">.</span><span class="nx">name</span>
      <span class="vi">@pageDir = </span><span class="nx">@outputDir</span> <span class="o">+</span> <span class="s">&quot;/</span><span class="si">#{</span><span class="nx">pageName</span><span class="si">}</span><span class="s">&quot;</span>

      <span class="nx">callback</span> <span class="kc">null</span>

  <span class="nv">getImages: </span><span class="nf">(callback) =&gt;</span>
    <span class="k">if</span> <span class="nx">@nextPageLink</span><span class="p">.</span><span class="nx">length</span>
      <span class="nv">url = </span><span class="nx">@nextPageLink</span>
    <span class="k">else</span>
      <span class="nv">url = </span><span class="s">&quot;https://graph.facebook.com/</span><span class="si">#{</span><span class="nx">@fbPageId</span><span class="si">}</span><span class="s">/feed?fields=link,to&amp;access_token=</span><span class="si">#{</span><span class="nx">@accessToken</span><span class="si">}</span><span class="s">&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Create a progress bar to show progress</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@getImagePageBar</span> <span class="o">?=</span> <span class="k">new</span> <span class="nx">ProgressBar</span> <span class="s">&#39;-- Getting image links [:bar] :percent :current/:total&#39;</span><span class="p">,</span> 
      <span class="nv">total: </span><span class="nx">@limit</span>
      <span class="nv">width: </span><span class="mi">20</span>

    <span class="nx">request</span><span class="p">.</span><span class="nx">get</span> <span class="nx">url</span><span class="p">,</span> 
      <span class="nv">json: </span><span class="kc">true</span>
    <span class="p">,</span> <span class="nf">(err, body, response) =&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Handle errors</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">err</span> <span class="k">then</span> <span class="k">return</span> <span class="nx">callback</span> <span class="nx">err</span>
      <span class="k">if</span> <span class="nx">response</span><span class="p">.</span><span class="nx">error</span> <span class="k">then</span> <span class="k">return</span> <span class="nx">callback</span> <span class="nx">response</span><span class="p">.</span><span class="nx">error</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Store the next page link</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="vi">@nextPageLink = </span><span class="nx">response</span><span class="p">.</span><span class="nx">paging</span><span class="p">.</span><span class="nx">next</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Get image link from each response</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">entries = </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Parse each page entry and look for image id
If the imageLinks array is less than limit, get more links first
If it is already the limit, then go to next step</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">async</span><span class="p">.</span><span class="nx">forEach</span> <span class="nx">entries</span><span class="p">,</span> <span class="nx">@parseFeedEntry</span><span class="p">,</span> <span class="nf">(err) =&gt;</span>
        <span class="k">if</span> <span class="nx">@images</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="nx">@limit</span>
          <span class="nx">@getImages</span> <span class="nx">callback</span>
        <span class="k">else</span>
          <span class="nx">callback</span> <span class="kc">null</span>

  <span class="nv">parseFeedEntry: </span><span class="nf">(entry, callback) =&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>If already reach limit, don't do anything</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">@images</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="nx">@limit</span>
      <span class="k">return</span> <span class="nx">callback</span> <span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>If there is no link, don't do anything</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="o">not</span> <span class="nx">entry</span><span class="p">.</span><span class="nx">link</span>
      <span class="k">return</span> <span class="nx">callback</span> <span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>If there is a "to" field, which means it's a story submitted by other people, ignore entry</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">entry</span><span class="p">.</span><span class="nx">to</span>
      <span class="k">return</span> <span class="nx">callback</span> <span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>If the link doesn't contain "facebook.com/photo.php"
Don't do anything</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="o">not</span> <span class="sr">/facebook\.com\/photo\.php/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">entry</span><span class="p">.</span><span class="nx">link</span><span class="p">)</span>
      <span class="k">return</span> <span class="nx">callback</span> <span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Look for image page id in URL then get the image link</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">matches = </span><span class="nx">entry</span><span class="p">.</span><span class="nx">link</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/fbid=(\d+)&amp;/</span><span class="p">)</span> </pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>If not match, ignore link</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="o">not</span> <span class="nx">matches</span>
      <span class="k">return</span> <span class="nx">callback</span> <span class="kc">null</span>

    <span class="nv">imagePageId = </span><span class="nx">matches</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="nx">@getImage</span> <span class="nx">imagePageId</span><span class="p">,</span> <span class="nf">(err) =&gt;</span>
      <span class="k">if</span> <span class="nx">err</span> <span class="k">then</span> <span class="k">return</span> <span class="nx">callback</span> <span class="nx">err</span>
      <span class="nx">@getImagePageBar</span><span class="p">.</span><span class="nx">tick</span><span class="p">()</span>
      <span class="nx">callback</span> <span class="kc">null</span>

  <span class="nv">getImage: </span><span class="nf">(imagePageId, callback) =&gt;</span>
    <span class="nv">url = </span><span class="s">&quot;https://graph.facebook.com/</span><span class="si">#{</span><span class="nx">imagePageId</span><span class="si">}</span><span class="s">?fields=images&amp;access_token=</span><span class="si">#{</span><span class="nx">@accessToken</span><span class="si">}</span><span class="s">&quot;</span>

    <span class="nx">request</span><span class="p">.</span><span class="nx">get</span> <span class="nx">url</span><span class="p">,</span> 
      <span class="nv">json: </span><span class="kc">true</span>
    <span class="p">,</span> <span class="nf">(err, body, response) =&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>Handle errors</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">err</span> <span class="k">then</span> <span class="k">return</span> <span class="nx">callback</span> <span class="nx">err</span>
      <span class="k">if</span> <span class="nx">response</span><span class="p">.</span><span class="nx">error</span>
        <span class="k">if</span> <span class="nx">response</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">code</span> <span class="o">is</span> <span class="mi">100</span>
          <span class="k">return</span> <span class="nx">callback</span> <span class="kc">null</span>
        <span class="k">else</span>
          <span class="k">return</span> <span class="nx">callback</span> <span class="nx">response</span><span class="p">.</span><span class="nx">error</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>Store the image link and created time to download image later</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">link = </span><span class="nx">response</span><span class="p">.</span><span class="nx">images</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">source</span>
      <span class="nv">datetime = </span><span class="nx">response</span><span class="p">.</span><span class="nx">created_time</span>

      <span class="nx">@images</span><span class="p">.</span><span class="nx">push</span>
        <span class="nv">link: </span><span class="nx">link</span>
        <span class="nv">datetime: </span><span class="nx">datetime</span>

      <span class="nx">callback</span> <span class="kc">null</span>

  <span class="nv">createFolders: </span><span class="nf">(callback) =&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Create store directory</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="o">not</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">existsSync</span> <span class="nx">@outputDir</span>
      <span class="nx">fs</span><span class="p">.</span><span class="nx">mkdirSync</span> <span class="nx">@outputDir</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>Create directory for page</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="o">not</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">existsSync</span> <span class="nx">@pageDir</span>
      <span class="nx">fs</span><span class="p">.</span><span class="nx">mkdirSync</span> <span class="nx">@pageDir</span>

    <span class="nx">callback</span> <span class="kc">null</span>

  <span class="nv">downloadImages: </span><span class="nf">(callback) =&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>Create a progress bar to show progress</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;\n&quot;</span>
    <span class="nx">@downloadImageBar</span> <span class="o">?=</span> <span class="k">new</span> <span class="nx">ProgressBar</span> <span class="s">&#39;-- Downloading images [:bar] :percent :current/:total&#39;</span><span class="p">,</span> 
      <span class="nv">total: </span><span class="nx">@images</span><span class="p">.</span><span class="nx">length</span>
      <span class="nv">width: </span><span class="mi">20</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>Start downloading images</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">async</span><span class="p">.</span><span class="nx">forEachLimit</span> <span class="nx">@images</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="nx">@downloadImage</span><span class="p">,</span> <span class="nx">callback</span>

  <span class="nv">downloadImage: </span><span class="nf">(image, callback) =&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>Create the image name path
Using the image created time as the file name</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">extension = </span><span class="nx">image</span><span class="p">.</span><span class="nx">link</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/(jpg|png|gif)/</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="nv">imageName = </span><span class="nx">moment</span><span class="p">(</span><span class="nx">image</span><span class="p">.</span><span class="nx">datetime</span><span class="p">).</span><span class="nx">format</span><span class="p">(</span><span class="s">&#39;DD_MM_YYYY_HH_mm_ss&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;.&quot;</span> <span class="o">+</span> <span class="nx">extension</span>
    <span class="nv">imagePath = </span><span class="nx">@pageDir</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span><span class="o">+</span> <span class="nx">imageName</span>

    <span class="nv">cb = </span><span class="o">=&gt;</span>
      <span class="nx">@downloadImageBar</span><span class="p">.</span><span class="nx">tick</span><span class="p">()</span>
      <span class="nx">callback</span> <span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>If image already exists, skip downloading</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">existsSync</span><span class="p">(</span><span class="nx">imagePath</span><span class="p">)</span>
      <span class="k">return</span> <span class="nx">cb</span><span class="p">()</span>

    <span class="nv">writeStream = </span><span class="nx">fs</span><span class="p">.</span><span class="nx">createWriteStream</span> <span class="nx">imagePath</span>

    <span class="nx">writeStream</span><span class="p">.</span><span class="nx">on</span> <span class="s">&#39;error&#39;</span><span class="p">,</span> <span class="nf">(err) -&gt;</span>
      <span class="nx">callback</span> <span class="nx">err</span>

    <span class="nx">writeStream</span><span class="p">.</span><span class="nx">on</span> <span class="s">&#39;close&#39;</span><span class="p">,</span> <span class="nx">cb</span>

    <span class="nx">request</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">image</span><span class="p">.</span><span class="nx">link</span><span class="p">).</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">writeStream</span><span class="p">)</span>

<span class="nv">module.exports = </span><span class="nx">Scrapper</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 